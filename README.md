# Heapviz

**Warning: This probably shouldn't be used for anything important. It
requires patching and building a custom Ruby**

Produces a png of a json dump of the Ruby objspace. Heap dump images
are organised in rows and columns:

* A heap page is a vertical column 4 pixels wide
* A slot is a vertical chunk that is 4 pixels wide and
  (4*slot_size/sizeof(RVALUE)) tall. so 40 byte slots are 4x4 pixels,
  80 bytes slots are 4x8 pixels, 160 bytes are 4x16 pixels and so on.

## Running

This script relies on patching the Ruby interpreter you wish to dump
the heap for. This library parses the json generated by
`ObjectSpace.dump_all` but currently this output doesn't provide any
information about the page in which the object resides. The patch
included adds page information to the dump in the form of a page
address and a slot size field in each JSON object representing an
RVALUE.

So instructions to get this running are as follows:

* download and build a Ruby source tree
* apply the patch in the root of this repo

```
git clone https://github.com/eightbitraptor/heapviz heapviz
cd ..
git clone https://github.com/ruby/ruby ruby
cd ruby
# see what the patch will do and check it applies cleanly
git apply --stat ../heapviz/0001-DO-NOT-MERGE-Pass-the-page-down-to-each_obj_callback.patch
git apply --check ../heapviz/0001-DO-NOT-MERGE-Pass-the-page-down-to-each_obj_callback.patch
# apply the patch as a commit
git am < ../heapviz/0001-DO-NOT-MERGE-Pass-the-page-down-to-each_obj_callback.patch

# build ruby (see https://github.com/ko1/rubyhackchallenge if you haven't done this before)
./autogen.sh
./configure
make
```

Now you need to generate your output dumps. Write a script that dumps
the heap to a file, put this in `test.rb` or something like it

```
require 'objspace'
ObjectSpace.dump_all(output: File.new("output.json", "w"))
```

Run that with your custom Ruby

```
./ruby test.rb
```

Then run this script with your json output, and a filename of a png to write to (the png doesn't need to exist)

```
../heapviz/exe/heapviz output.json output.png
open output.png
```
